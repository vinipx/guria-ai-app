<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GURIA - Chat Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'chat-dark': '#111111',
                        'chat-darker': '#0a0a0a',
                        'chat-light': '#1a1a1a',
                        'chat-accent': '#e0af68',
                        'chat-accent-hover': '#ff9e64',
                        'chat-border': '#2a2a2a'
                    }
                }
            }
        }
        
        // Configure marked with syntax highlighting
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (e) {}
                }
                return code;
            },
            breaks: true,
            gfm: true,
            headerIds: true,
            mangle: false,
            pedantic: false,
            smartLists: true,
            smartypants: true
        });
    </script>
    <style>
        /* Base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #e4e4e4;
            background-color: #111111;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111111;
        }
        ::-webkit-scrollbar-thumb {
            background: #2a2a2a;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }

        /* Chat message styling */
        .chat-message {
            display: flex;
            margin-bottom: 1.5rem;
            padding: 1rem;
        }

        .chat-message.user {
            background-color: #111111;
        }

        .chat-message.assistant {
            background-color: #1a1a1a;
            border-bottom: 1px solid rgba(224, 175, 104, 0.2);
        }

        .message-content {
            max-width: 48rem;
            margin: 0 auto;
            color: #e4e4e4;
            font-size: 1rem;
            line-height: 1.7;
            padding: 0 1rem;
            width: 100%;
        }

        .user .message-content {
            background-color: #2d2d2d;
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .assistant .message-content {
            background-color: transparent;
        }

        /* Message content styling */
        .message-content {
            font-size: 1rem;
            line-height: 1.6;
            color: #e4e4e4;
        }

        /* Chain of thought styling */
        .thinking-start, .thinking-end {
            display: block;
            font-style: italic;
            color: #888;
            margin: 1rem 0;
            padding: 0.75rem 1rem;
            background-color: #1E1E1E;
            border-left: 3px solid #404040;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .chain-of-thought {
            font-style: italic;
            color: #888;
            margin: 0.75rem 0;
            padding: 0.75rem 1rem;
            background-color: #1E1E1E;
            border-left: 3px solid #404040;
            border-radius: 0 0.5rem 0.5rem 0;
            line-height: 1.6;
        }

        .chain-of-thought p {
            margin: 0.5rem 0;
        }

        .chain-of-thought * {
            font-style: italic;
            color: #888;
        }

        /* Enhanced markdown styling */
        .message-content h1 {
            font-size: 2em;
            font-weight: 700;
            margin: 1.5em 0 0.8em;
            color: #e0af68;
            padding: 0.5rem 1rem;
            background-color: rgba(224, 175, 104, 0.05);
            border-left: 4px solid #e0af68;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .message-content h2 {
            font-size: 1.7em;
            font-weight: 600;
            margin: 1.4em 0 0.8em;
            color: #e0af68;
            padding: 0.4rem 1rem;
            background-color: rgba(224, 175, 104, 0.05);
            border-left: 3px solid #e0af68;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .message-content h3 {
            font-size: 1.4em;
            font-weight: 600;
            margin: 1.3em 0 0.7em;
            color: #e0af68;
            padding: 0.3rem 1rem;
            background-color: rgba(224, 175, 104, 0.05);
            border-left: 2px solid #e0af68;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .message-content h4, .message-content h5, .message-content h6 {
            font-size: 1.2em;
            font-weight: 600;
            margin: 1.2em 0 0.6em;
            color: #e0af68;
            padding: 0.3rem 1rem;
            background-color: rgba(224, 175, 104, 0.05);
            border-left: 2px solid #e0af68;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .message-content p {
            margin: 1rem 0;
            line-height: 1.6;
        }

        .message-content ul, .message-content ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        .message-content li {
            margin: 0.5rem 0;
        }

        .message-content a {
            color: #7dcfff;
            text-decoration: none;
            border-bottom: 1px dashed #7dcfff;
        }

        .message-content a:hover {
            border-bottom: 1px solid #7dcfff;
        }

        .message-content strong {
            color: #e0af68;
            font-weight: 600;
        }

        .message-content em {
            color: #bb9af7;
        }

        .message-content blockquote {
            margin: 1rem 0;
            padding: 0.5rem 1rem;
            border-left: 3px solid #e0af68;
            background-color: rgba(224, 175, 104, 0.1);
            border-radius: 0 0.25rem 0.25rem 0;
            color: #ccc;
        }

        /* Code block styling */
        .message-content pre {
            background-color: #000000 !important;
            padding: 1.25rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #333;
        }

        .message-content pre code {
            color: #ffffff !important;
            background: transparent !important;
            padding: 0 !important;
            font-family: 'Fira Code', 'Consolas', monospace !important;
            font-size: 0.9rem !important;
            line-height: 1.5 !important;
        }

        .message-content code:not(pre code) {
            background-color: #000000 !important;
            color: #ffffff !important;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
            border: 1px solid #333;
        }

        /* Tables */
        .message-content table {
            width: 100%;
            margin: 1rem 0;
            border-collapse: collapse;
        }

        .message-content th, .message-content td {
            padding: 0.5rem;
            border: 1px solid #404040;
            text-align: left;
        }

        .message-content th {
            background-color: #1E1E1E;
            color: #e0af68;
            font-weight: 600;
        }

        .message-content tr:nth-child(even) {
            background-color: #1E1E1E;
        }

        /* Syntax highlighting colors */
        .hljs {
            background: #000000 !important;
            color: #ffffff !important;
        }
        .hljs-keyword { color: #ff79c6 !important; }
        .hljs-string { color: #f1fa8c !important; }
        .hljs-number { color: #bd93f9 !important; }
        .hljs-function { color: #50fa7b !important; }
        .hljs-title { color: #50fa7b !important; }
        .hljs-params { color: #f8f8f2 !important; }
        .hljs-comment { color: #6272a4 !important; }
        .hljs-literal { color: #bd93f9 !important; }
        .hljs-built_in { color: #8be9fd !important; }
        .hljs-type { color: #8be9fd !important; }
        .hljs-tag { color: #ff79c6 !important; }
        .hljs-attribute { color: #50fa7b !important; }
        .hljs-symbol { color: #f1fa8c !important; }
        .hljs-section { color: #50fa7b !important; }
        .hljs-name { color: #ff79c6 !important; }

        /* Typing indicator */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #3498db;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.3s linear infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.15s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.3s;
        }
        
        @keyframes bounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-4px);
            }
        }
        
        .error-message {
            color: #e74c3c;
            padding: 10px;
            border-radius: 4px;
            background-color: #fde8e8;
            margin: 5px 0;
        }

        /* Chat history styling */
        .chat-history-item {
            position: relative;
            padding: 0.75rem;
            padding-right: 2.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        .chat-history-item:hover {
            background-color: #1a1a1a;
        }

        .chat-history-item .delete-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            z-index: 10;
        }

        .chat-history-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn svg {
            width: 16px;
            height: 16px;
            color: #666666;
            transition: color 0.2s ease-in-out;
        }

        .delete-btn:hover svg {
            color: #e0af68;
        }

        .chat-history-item .content {
            padding-right: 24px;
        }

        /* User message styling */
        .user-message .message-content {
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            max-width: 80%;
            margin-left: auto;
        }

        /* Assistant message styling */
        .assistant-message .message-content {
            background-color: #000000;
            color: #ffffff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            max-width: 80%;
        }

        /* Chat history header */
        .chat-history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background-color: #000000;
        }

        .chat-history-title {
            display: flex;
            align-items: center;
        }

        .chat-history-title .gur {
            color: #ffffff;
            margin-right: -6px;  
            font-weight: 700;
            font-size: 1.6em;
            letter-spacing: -1.2px;  
        }

        .chat-history-title .ia {
            color: #e0af68;
            margin-right: 12px;
            font-weight: 700;
            font-size: 1.6em;
            letter-spacing: -1.2px;  
        }

        .chat-history-title .chat {
            color: #888;
            font-style: italic;
            font-size: 0.9em;
        }

        .clear-all-btn {
            padding: 4px 8px;
            font-size: 0.875rem;
            color: #e0af68;
            border: 1px solid #e0af68;
            border-radius: 4px;
            background: transparent;
            transition: all 0.2s ease-in-out;
        }

        .clear-all-btn:hover {
            background-color: #e0af68;
            color: #000000;
        }

        /* Chat history container */
        #chat-history-list {
            flex: 1;
            overflow-y: auto;
            background-color: #000000;
        }

        /* Shutdown button container */
        .shutdown-container {
            padding: 1rem;
            background-color: #000000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shutdown-btn {
            width: 100%;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: #e0af68;
            color: #000000;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }

        .shutdown-btn:hover {
            background-color: #c99a5b;
        }

        .shutdown-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Button container at the bottom */
        .bottom-buttons {
            padding: 1rem;
            background-color: #000000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Common button styles */
        .action-btn {
            width: 100%;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }

        .new-chat-btn {
            background-color: transparent;
            border: 1px solid #e0af68;
            color: #e0af68;
        }

        .new-chat-btn:hover {
            background-color: #e0af68;
            color: #000000;
        }

        .shutdown-btn {
            background-color: #e0af68;
            color: #000000;
            border: none;
        }

        .shutdown-btn:hover {
            background-color: #c99a5b;
        }

        .action-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Export button */
        .export-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            background-color: #e0af68;
            color: #000000;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .export-btn:hover {
            background-color: #c99a5b;
        }

        .export-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Export button and dropdown */
        .export-container {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        .export-btn {
            padding: 0.5rem 1rem;
            background-color: #e0af68;
            color: #000000;
            border: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .export-btn:hover {
            background-color: #c99a5b;
        }

        .export-btn svg {
            width: 16px;
            height: 16px;
        }

        .export-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 0.5rem 0;
            min-width: 150px;
            display: none;
            z-index: 1000;
        }

        .export-dropdown.show {
            display: block;
        }

        .export-dropdown button {
            width: 100%;
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            color: #e0e0e0;
            text-align: left;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-dropdown button:hover {
            background-color: #333;
            color: #e0af68;
        }

        .export-dropdown button svg {
            width: 16px;
            height: 16px;
        }

        /* Code snippet styling */
        pre {
            background-color: #1a1a1a !important;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        pre code {
            color: #e6e6e6 !important;
            background-color: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Style for inline code */
        code:not(pre code) {
            background-color: #1a1a1a !important;
            color: #e6e6e6 !important;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9em;
        }

        /* Syntax highlighting colors for dark theme */
        .hljs {
            background: #1a1a1a !important;
            color: #e6e6e6 !important;
        }
        .hljs-keyword { color: #ff79c6 !important; }
        .hljs-string { color: #f1fa8c !important; }
        .hljs-number { color: #bd93f9 !important; }
        .hljs-function { color: #50fa7b !important; }
        .hljs-title { color: #50fa7b !important; }
        .hljs-params { color: #f8f8f2 !important; }
        .hljs-comment { color: #6272a4 !important; }
        .hljs-literal { color: #bd93f9 !important; }
        .hljs-built_in { color: #8be9fd !important; }
        .hljs-type { color: #8be9fd !important; }
        .hljs-tag { color: #ff79c6 !important; }
        .hljs-attribute { color: #50fa7b !important; }
        .hljs-symbol { color: #f1fa8c !important; }
        .hljs-section { color: #50fa7b !important; }
        .hljs-name { color: #ff79c6 !important; }
    </style>
</head>
<body class="bg-chat-dark text-gray-100 min-h-screen font-sans">
    <!-- Main container with sidebar -->
    <div class="flex h-screen">
        <!-- Chat history sidebar -->
        <div id="chat-sidebar" class="w-80 flex flex-col h-full bg-black">
            <div class="chat-history-header">
                <div class="chat-history-title flex items-center gap-2 mb-4">
                    <span class="gur">GUR</span>
                    <span class="ia">IA</span>
                    <span class="chat">CHAT</span>
                </div>
                <button id="clear-history" class="clear-all-btn">
                    Clear All
                </button>
            </div>
            <div id="chat-history-list">
                <!-- Chat history items will be dynamically added here -->
            </div>
            <div class="bottom-buttons">
                <button onclick="startNewChat()" class="action-btn new-chat-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span>New Chat</span>
                </button>
                <button onclick="shutdownServer()" class="action-btn shutdown-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 5.636a9 9 0 1012.728 0M12 3v9"></path>
                    </svg>
                    <span>Shutdown</span>
                </button>
            </div>
        </div>

        <!-- Main chat area -->
        <div class="flex-1 flex flex-col h-full relative">
            <!-- Export button and dropdown -->
            <div class="export-container">
                <button onclick="toggleExportDropdown()" class="export-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span>Export</span>
                </button>
                <div class="export-dropdown" id="exportDropdown">
                    <button onclick="exportChat('txt')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span>Text (.txt)</span>
                    </button>
                    <button onclick="exportChat('md')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0112.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        <span>Markdown (.md)</span>
                    </button>
                    <button onclick="exportChat('pdf')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                        </svg>
                        <span>PDF (.pdf)</span>
                    </button>
                </div>
            </div>
            
            <!-- Messages container -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4">
                <!-- Messages will be added here -->
            </div>

            <!-- Input area -->
            <div class="border-t border-chat-border bg-chat-dark p-4">
                <div class="max-w-4xl mx-auto">
                    <div class="relative">
                        <textarea 
                            id="query" 
                            class="w-full bg-chat-darker border border-chat-border text-gray-100 rounded-lg py-3 px-4 pr-24 focus:outline-none focus:ring-2 focus:ring-chat-accent focus:border-transparent transition-all resize-none"
                            rows="3"
                            placeholder="Send a message..."
                        ></textarea>
                        <button 
                            id="submit" 
                            class="absolute bottom-2 right-2 bg-chat-accent hover:bg-chat-accent-hover text-black font-medium p-2 rounded-lg transition-all flex items-center justify-center"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    <script>
        let currentChatId = null;
        let currentResponseElement = null;
        let isGenerating = false;
        let isThinking = false;
        let thinkingContent = '';

        async function shutdownServer() {
            // Show shutdown modal
            document.getElementById('shutdownModal').classList.remove('hidden');
            
            try {
                const response = await fetch('/shutdown', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Wait a moment for the server to start shutting down
                    setTimeout(() => {
                        window.location.href = '/goodbye';
                    }, 1500);
                } else {
                    console.error('Failed to shutdown server');
                    // Hide shutdown modal if there's an error
                    document.getElementById('shutdownModal').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error during shutdown:', error);
                // Hide shutdown modal if there's an error
                document.getElementById('shutdownModal').classList.add('hidden');
            }
        }

        // Function to create a message element
        function createMessageElement(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
            
            const innerDiv = document.createElement('div');
            innerDiv.className = 'message-content';
            
            if (isUser) {
                innerDiv.textContent = content;
            } else {
                innerDiv.innerHTML = marked.parse(content);
                innerDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
            
            messageDiv.appendChild(innerDiv);
            return messageDiv;
        }

        // Function to format timestamp
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        // Function to load chat history
        async function refreshChatHistory() {
            try {
                const response = await fetch('/chat_history');
                const data = await response.json();
                const chatHistoryList = document.getElementById('chat-history-list');
                chatHistoryList.innerHTML = ''; // Clear existing items
                
                data.forEach(chat => {
                    const item = createChatHistoryItem(chat);
                    chatHistoryList.appendChild(item);
                });
            } catch (error) {
                console.error('Error refreshing chat history:', error);
            }
        }

        // Function to create a chat history item
        function createChatHistoryItem(chat) {
            const item = document.createElement('div');
            item.className = 'chat-history-item';
            
            // Add click handler for loading chat
            item.onclick = (e) => {
                // Don't load chat if clicking delete button
                if (!e.target.closest('.delete-btn')) {
                    loadChat(chat.id);
                }
            };
            
            const timestamp = new Date(chat.timestamp);
            const formattedDate = timestamp.toLocaleString();
            
            // Truncate prompt for display (35 characters max)
            const truncatedPrompt = chat.prompt.length > 35 
                ? chat.prompt.substring(0, 32) + '...'
                : chat.prompt;
            
            item.innerHTML = `
                <div class="flex items-center justify-between pr-8">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-300 truncate">
                            ${truncatedPrompt}
                        </p>
                        <p class="text-xs text-gray-500">
                            ${formattedDate}
                        </p>
                    </div>
                    <button class="delete-btn" title="Delete chat">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;

            // Add click handler for delete button
            const deleteBtn = item.querySelector('.delete-btn');
            deleteBtn.onclick = async (e) => {
                e.stopPropagation(); // Prevent chat from loading
                
                if (confirm('Are you sure you want to delete this chat?')) {
                    try {
                        const response = await fetch('/delete_chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ chat_id: chat.id })
                        });

                        if (response.ok) {
                            await refreshChatHistory();
                        } else {
                            console.error('Failed to delete chat');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                }
            };
            
            return item;
        }

        // Add some CSS for the delete button
        const style = document.createElement('style');
        style.textContent = `
            .chat-history-item {
                position: relative;
            }
            .delete-btn {
                opacity: 0;
                transition: opacity 0.2s ease-in-out;
            }
            .chat-history-item:hover .delete-btn {
                opacity: 1;
            }
        `;
        document.head.appendChild(style);

        // Function to delete a single chat
        async function deleteChat(chatId) {
            try {
                const response = await fetch('/delete_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ chat_id: chatId })
                });

                if (response.ok) {
                    refreshChatHistory(); // Refresh the chat history
                } else {
                    console.error('Failed to delete chat');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadChat(chatId) {
            try {
                const response = await fetch(`/chat/${chatId}`);
                const chat = await response.json();
                
                // Clear existing messages
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                
                // Add user message
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'chat-message user flex items-start mb-4';
                userMessageDiv.innerHTML = `
                    <div class="flex-shrink-0 mr-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                            <span class="text-white font-bold">U</span>
                        </div>
                    </div>
                    <div class="flex-1 bg-blue-100 rounded-lg p-3 shadow message-content">
                        <p class="text-gray-800">${chat.prompt}</p>
                    </div>
                `;
                chatMessages.appendChild(userMessageDiv);
                
                // Add assistant message
                const assistantMessageDiv = document.createElement('div');
                assistantMessageDiv.className = 'chat-message assistant flex items-start mb-4';
                assistantMessageDiv.innerHTML = `
                    <div class="flex-shrink-0 mr-3">
                        <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
                            <span class="text-white font-bold">A</span>
                        </div>
                    </div>
                    <div class="flex-1 rounded-lg p-3 shadow message-content">
                        <div class="prose prose-sm max-w-none">
                            ${formatResponse(chat.response)}
                        </div>
                    </div>
                `;
                chatMessages.appendChild(assistantMessageDiv);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        async function startNewChat() {
            // Clear the messages container
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            // Clear the input field
            const inputField = document.getElementById('query');
            if (inputField) {
                inputField.value = '';
            }

            // Reset current chat ID
            currentChatId = null;

            // Focus the input field
            if (inputField) {
                inputField.focus();
            }
        }

        async function sendMessage() {
            const userInput = document.getElementById('query').value.trim();
            const model = '{{ selected_model }}';
            
            if (!userInput || isGenerating) return;
            
            // Reset thinking state
            isThinking = false;
            thinkingContent = '';
            
            // Clear input and disable
            const inputField = document.getElementById('query');
            inputField.value = '';
            inputField.disabled = true;
            isGenerating = true;
            
            // Add user message to chat
            appendMessage('user', userInput);
            
            try {
                // Show typing indicator
                const typingIndicator = showTypingIndicator();
                
                // Send request to backend
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: userInput,
                        model: model,
                        chat_id: currentChatId
                    })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let responseText = '';
                let currentMessageDiv = null;
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.error) {
                                    hideTypingIndicator(typingIndicator);
                                    appendMessage('assistant', `Error: ${data.error}`);
                                    break;
                                }
                                
                                if (data.response) {
                                    responseText += data.response;
                                    if (!currentMessageDiv) {
                                        hideTypingIndicator(typingIndicator);
                                        currentMessageDiv = appendMessage('assistant', '');
                                    }
                                    updateMessage(currentMessageDiv, responseText);
                                }
                                
                                if (data.chat_id && !currentChatId) {
                                    currentChatId = data.chat_id;
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data:', e);
                            }
                        }
                    }
                }
                
                // Refresh chat history to update titles
                await refreshChatHistory();
                
            } catch (error) {
                console.error('Error:', error);
                appendMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            } finally {
                // Re-enable input
                inputField.disabled = false;
                isGenerating = false;
                inputField.focus();
            }
        }

        function formatResponse(text) {
            // Check if we're inside a thinking block
            const thinkStartMatch = text.match(/<think>/);
            const thinkEndMatch = text.match(/<\/think>/);
            
            if (thinkStartMatch && !thinkEndMatch) {
                isThinking = true;
                thinkingContent = text.replace('<think>', '');
                return `
                    <div class="thinking-start">Thinking.....</div>
                    <div class="chain-of-thought">${marked.parse(thinkingContent)}</div>
                `;
            } else if (thinkEndMatch) {
                isThinking = false;
                thinkingContent = text.substring(0, text.indexOf('</think>'));
                const remainingContent = text.substring(text.indexOf('</think>') + 8);
                return `
                    <div class="thinking-start">Thinking.....</div>
                    <div class="chain-of-thought">${marked.parse(thinkingContent)}</div>
                    <div class="thinking-end">Done, let me elaborate for you...</div>
                    ${marked.parse(remainingContent)}
                `;
            } else if (isThinking) {
                thinkingContent = text;
                return `
                    <div class="thinking-start">Thinking.....</div>
                    <div class="chain-of-thought">${marked.parse(thinkingContent)}</div>
                `;
            }
            
            return marked.parse(text);
        }

        function appendMessage(role, content) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (role === 'user') {
                contentDiv.textContent = content;
            } else {
                contentDiv.innerHTML = formatResponse(content);
            }
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageDiv;
        }

        function updateMessage(messageDiv, content) {
            if (!messageDiv) return;
            
            const contentDiv = messageDiv.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.innerHTML = formatResponse(content);
                
                // Highlight code blocks
                contentDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
            
            // Scroll to bottom
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const chatMessages = document.getElementById('chat-messages');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-message assistant';
            typingIndicator.innerHTML = `
                <div class="flex-shrink-0 mr-3">
                    <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
                        <span class="text-white font-bold">A</span>
                    </div>
                </div>
                <div class="flex-1 rounded-lg p-3 shadow message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingIndicator);
            
            return typingIndicator;
        }

        function hideTypingIndicator(typingIndicator) {
            typingIndicator.remove();
        }

        // Toggle export dropdown
        function toggleExportDropdown() {
            document.getElementById('exportDropdown').classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.export-btn') && !event.target.matches('.export-btn *')) {
                const dropdowns = document.getElementsByClassName('export-dropdown');
                for (const dropdown of dropdowns) {
                    if (dropdown.classList.contains('show')) {
                        dropdown.classList.remove('show');
                    }
                }
            }
        }

        // Handle Enter key to submit
        document.getElementById('query').addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // Handle form submission
        document.getElementById('submit').addEventListener('click', sendMessage);

        // Initial load of chat history
        refreshChatHistory();

        // Refresh chat history periodically
        setInterval(refreshChatHistory, 5000);

        async function exportChat(format) {
            try {
                if (!currentChatId) {
                    console.error('No chat to export');
                    return;
                }

                const chatMessages = document.getElementById('chat-messages');
                let content = '';
                
                if (format === 'pdf') {
                    const response = await fetch(`/export_pdf/${currentChatId}`);
                    if (!response.ok) {
                        throw new Error('Failed to export PDF');
                    }
                    const blob = await response.blob();
                    downloadFile(blob, `chat_export.pdf`, 'application/pdf');
                } else {
                    // Get all messages
                    const messages = chatMessages.querySelectorAll('.chat-message');
                    messages.forEach((msg) => {
                        const isUser = msg.classList.contains('user');
                        const messageContent = msg.querySelector('.message-content').textContent;
                        
                        if (format === 'txt') {
                            content += `${isUser ? 'User' : 'Assistant'}: ${messageContent}\n\n`;
                        } else if (format === 'md') {
                            content += `### ${isUser ? 'User' : 'Assistant'}\n${messageContent}\n\n`;
                        }
                    });

                    const mimeType = format === 'txt' ? 'text/plain' : 'text/markdown';
                    const blob = new Blob([content], { type: mimeType });
                    downloadFile(blob, `chat_export.${format}`, mimeType);
                }
            } catch (error) {
                console.error('Error exporting chat:', error);
                alert('Failed to export chat. Please try again.');
            } finally {
                // Close dropdown
                document.getElementById('exportDropdown').classList.remove('show');
            }
        }

        function downloadFile(blob, filename, mimeType) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        }
    </script>
</body>
</html>
